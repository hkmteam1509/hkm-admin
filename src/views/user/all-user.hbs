{{#section 'head'}}
<meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>All Guests</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- favicon
		============================================ -->
    <link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico">
    <!-- Google Fonts
		============================================ -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,700,900" rel="stylesheet">
    <!-- Bootstrap CSS
		============================================ -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <!-- Bootstrap CSS
		============================================ -->
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <!-- owl.carousel CSS
		============================================ -->
    <link rel="stylesheet" href="/css/owl.carousel.css">
    <link rel="stylesheet" href="/css/owl.theme.css">
    <link rel="stylesheet" href="/css/owl.transitions.css">
    <!-- animate CSS
		============================================ -->
    <link rel="stylesheet" href="/css/animate.css">
    <!-- normalize CSS
		============================================ -->
    <link rel="stylesheet" href="/css/normalize.css">
    <!-- meanmenu icon CSS
		============================================ -->
    <link rel="stylesheet" href="/css/meanmenu.min.css">
    <!-- main CSS
		============================================ -->
    <link rel="stylesheet" href="/css/main.css">
    <!-- educate icon CSS
		============================================ -->
    <link rel="stylesheet" href="/css/educate-custon-icon.css">
    <!-- modals CSS
		============================================ -->
    <link rel="stylesheet" href="/css/modals.css">
    <!-- morrisjs CSS
		============================================ -->
    <link rel="stylesheet" href="/css/morrisjs/morris.css">
    <!-- mCustomScrollbar CSS
		============================================ -->
    <link rel="stylesheet" href="/css/scrollbar/jquery.mCustomScrollbar.min.css">
    <!-- metisMenu CSS
		============================================ -->
    <link rel="stylesheet" href="/css/metisMenu/metisMenu.min.css">
    <link rel="stylesheet" href="/css/metisMenu/metisMenu-vertical.css">
    <!-- calendar CSS
		============================================ -->
    <link rel="stylesheet" href="/css/calendar/fullcalendar.min.css">
    <link rel="stylesheet" href="/css/calendar/fullcalendar.print.min.css">
    <!-- x-editor CSS
		============================================ -->
    <link rel="stylesheet" href="/css/editor/select2.css">
    <link rel="stylesheet" href="/css/editor/datetimepicker.css">
    <link rel="stylesheet" href="/css/editor/bootstrap-editable.css">
    <link rel="stylesheet" href="/css/editor/x-editor-style.css">
    <!-- normalize CSS
        ============================================ -->
    <link rel="stylesheet" href="/css/data-table/bootstrap-table.css">
    <link rel="stylesheet" href="/css/data-table/bootstrap-editable.css">
    <!-- style CSS
		============================================ -->
    <link rel="stylesheet" href="style.css">
    <!-- responsive CSS
		============================================ -->
    <link rel="stylesheet" href="/css/responsive.css">
    <!-- modernizr JS
		============================================ -->
    <link rel="stylesheet" href="/css/my-css.css">
    <script src="js/vendor/modernizr-2.8.3.min.js"></script>
{{/section}}

<div class="product-status mg-b-15">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <div class="product-status-wrap drp-lst">
                    <h4>All Users</h4>
                    <div class="asset-inner">
                        <table>
                           <thead>
                                <tr>
                                    <th>No.</th>
                                    <th>Name</th>
                                    <th>Gender</th>
                                    <th>Address</th>
                                    <th>Phone Number</th>
                                    <th>Action</th>
                                </tr>
                           </thead>
                            <tbody id="table-body">
                                {{#each users}}
                                <tr>
                                    <td>{{this.No}}</td>
                                    <td>{{this.f_firstname}} {{this.f_lastname}} </td>
                                    <td>
                                        {{#if this.f_sex}} 
                                        {{#isEqual this.f_sex 1}}Women{{/isEqual}} 
                                        {{#isEqual this.f_sex 2}}Other{{/isEqual}}
                                        {{else}}
                                            {{#isEqual this.f_sex 0}}
                                                Men
                                            {{else}}
                                                Empty
                                            {{/isEqual}}
                                        {{/if}}
                                    </td>
                                    <td>
                                        {{#if this.f_address}}
                                            {{this.f_address}}
                                        {{else}}
                                            Empty
                                        {{/if}}
                                    </td>
                                    <td>
                                        {{#if this.f_phone}}
                                            {{this.f_phone}}
                                        {{else}}
                                            Empty
                                        {{/if}}
                                    </td>
                                    <td>
                                        <div class="modal-area-button">
                                            <a class="Primary mg-b-10" href="/users/{{this.f_ID}}">Details</a>
                                            {{#isEqual this.f_permission 0}}
                                                <a id="block-btn-{{this.f_ID}}" type="button" class="Danger danger-color" href="" data-toggle="modal" data-target="#DangerModalalert" data-userid="{{this.f_ID}}" name="ask-block-user">Block</a>
                                                <a style="display: none;" id="unblock-btn-{{this.f_ID}}" type="button" class="Warning warning-color" href="" data-toggle="modal" data-target="#WarningModalalert" data-userid="{{this.f_ID}}" name="ask-unblock-user">Unblock</a>
                                            {{else}}
                                                <a style="display: none;" id="block-btn-{{this.f_ID}}" type="button" class="Danger danger-color" href="" data-toggle="modal" data-target="#DangerModalalert" data-userid="{{this.f_ID}}" name="ask-block-user">Block</a>
                                                <a id="unblock-btn-{{this.f_ID}}" type="button" class="Warning warning-color" href="" data-toggle="modal" data-target="#WarningModalalert" data-userid="{{this.f_ID}}" name="ask-unblock-user">Unblock</a>
                                            {{/isEqual}}
                                        </div>
                                    </td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                                    
                    <div id="DangerModalalert" class="modal modal-edu-general FullColor-popup-DangerModal fade" role="dialog">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-close-area modal-close-df">
                                    <a class="close" data-dismiss="modal" href="#"><i class="fa fa-close"></i></a>
                                </div>
                                <div class="modal-body">
                                    <span class="educate-icon educate-danger modal-check-pro information-icon-pro"></span>
                                    <h2>Block this guest?</h2>
                                    <p>If you block this guest, they can not access the shop's website anymore.</p>
                                </div>
                                <div class="modal-footer danger-md">
                                    <a data-dismiss="modal" href="#">Cancel</a>
                                    <a type="button" data-dismiss="modal" style="cursor: pointer;" name="block-user">Block</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="WarningModalalert" class="modal modal-edu-general Customwidth-popup-WarningModal fade" role="dialog">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-close-area modal-close-df">
                                    <a class="close" data-dismiss="modal" href="#"><i class="fa fa-close"></i></a>
                                </div>
                                <div class="modal-body">
                                    <span class="educate-icon educate-warning modal-check-pro information-icon-pro"></span>
                                    <h2>Unblock this guest?</h2>
                                    <p>If you unblock this guest, they can access the shop's website again.</p>
                                </div>
                                <div class="modal-footer warning-md">
                                    <a data-dismiss="modal" href="#">Cancel</a>
                                    <a type="button" data-dismiss="modal" style="cursor: pointer;" name="unblock-user">Unblock</a>
                                </div>
                            </div>
                        </div>
                    </div>
                	<!-- PAGER -->
			
				 <form 
                method="GET"
                action="/users">

                    {{#if paginationArray}}
                   <ul class="my-pagination">
                                <li class="my-page-item">
                                    <input onchange='this.form.submit();' style="display: none;" id="page-prev" value="{{prevPage}}" type="radio" name="page"/>
                                    <label for="page-prev"  class="my-page-button">Prev</label>
                                </li>
                                {{#each paginationArray }}  
                                    {{#if this.isCurrent}}
                                        <li class="my-page-item">
                                            <input onchange='this.form.submit();' style="display: none;" id="page-{{this.page}}" value="{{this.page}}" type="radio" name="page"/>
                                            <label for="page-{{this.page}}"  class="my-page-link my-current-page">{{this.page}}</label>
                                        </li>
                                    {{else}}
                                        <li class="my-page-item">
                                            <input onchange='this.form.submit();' style="display: none;" id="page-{{this.page}}" value="{{this.page}}" type="radio" name="page"/>
                                            <label for="page-{{this.page}}"  class="my-page-link">{{this.page}}</label>
                                        </li>
                                    {{/if}}
                                {{/each}}
                                <li class="my-page-item">
                                    <input onchange='this.form.submit();' style="display: none;" id="page-next" value="{{nextPage}}" type="radio" name="page"/>
                                    <label for="page-next"  class="my-page-button">Next</label>
                                </li>
                     </ul>
                     {{/if}}
                </form>
			
			<!-- /PAGER -->
                </div>
            </div>
        </div>
    </div>
</div>

{{#section 'script'}}
<!-- jquery
    ============================================ -->
<script src="js/vendor/jquery-1.12.4.min.js"></script>
<!-- bootstrap JS
    ============================================ -->
<script src="js/bootstrap.min.js"></script>
<!-- wow JS
    ============================================ -->
<script src="js/wow.min.js"></script>
<!-- price-slider JS
    ============================================ -->
<script src="js/jquery-price-slider.js"></script>
<!-- meanmenu JS
    ============================================ -->
<script src="js/jquery.meanmenu.js"></script>
<!-- owl.carousel JS
    ============================================ -->
<script src="js/owl.carousel.min.js"></script>
<!-- sticky JS
    ============================================ -->
<script src="js/jquery.sticky.js"></script>
<!-- scrollUp JS
    ============================================ -->
<script src="js/jquery.scrollUp.min.js"></script>
<!-- counterup JS
    ============================================ -->
<script src="js/counterup/jquery.counterup.min.js"></script>
<script src="js/counterup/waypoints.min.js"></script>
<script src="js/counterup/counterup-active.js"></script>
<!-- mCustomScrollbar JS
    ============================================ -->
<script src="js/scrollbar/jquery.mCustomScrollbar.concat.min.js"></script>
<script src="js/scrollbar/mCustomScrollbar-active.js"></script>
<!-- metisMenu JS
    ============================================ -->
<script src="js/metisMenu/metisMenu.min.js"></script>
<script src="js/metisMenu/metisMenu-active.js"></script>
<!-- data table JS
    ============================================ -->
<script src="js/data-table/bootstrap-table.js"></script>
<script src="js/data-table/tableExport.js"></script>
<script src="js/data-table/data-table-active.js"></script>
<script src="js/data-table/bootstrap-table-editable.js"></script>
<script src="js/data-table/bootstrap-editable.js"></script>
<script src="js/data-table/bootstrap-table-resizable.js"></script>
<script src="js/data-table/colResizable-1.5.source.js"></script>
<script src="js/data-table/bootstrap-table-export.js"></script>
<!--  editable JS
    ============================================ -->
<script src="js/editable/jquery.mockjax.js"></script>
<script src="js/editable/mock-active.js"></script>
<script src="js/editable/select2.js"></script>
<script src="js/editable/moment.min.js"></script>
<script src="js/editable/bootstrap-datetimepicker.js"></script>
<script src="js/editable/bootstrap-editable.js"></script>
<script src="js/editable/xediable-active.js"></script>
<!-- Chart JS
    ============================================ -->
<script src="js/chart/jquery.peity.min.js"></script>
<script src="js/peity/peity-active.js"></script>
<!-- tab JS
    ============================================ -->
<script src="js/tab.js"></script>
<!-- morrisjs JS
    ============================================ -->
<script src="js/morrisjs/raphael-min.js"></script>
<script src="js/morrisjs/morris.js"></script>
<script src="js/morrisjs/morris-active.js"></script>
<!-- morrisjs JS
    ============================================ -->
<script src="js/sparkline/jquery.sparkline.min.js"></script>
<script src="js/sparkline/jquery.charts-sparkline.js"></script>
<script src="js/sparkline/sparkline-active.js"></script>
<!-- calendar JS
    ============================================ -->
<script src="js/calendar/moment.min.js"></script>
<script src="js/calendar/fullcalendar.min.js"></script>
<script src="js/calendar/fullcalendar-active.js"></script>
<!-- plugins JS
    ============================================ -->
<script src="js/plugins.js"></script>
<!-- main JS
    ============================================ -->
<script src="js/main.js"></script>
<!-- tawk chat JS
    ============================================ -->
<!-- <script src="js/tawk-chat.js"></script> -->

<script>
    $(document).ready(function(){
        var id, permission;
        $('#DangerModalalert').on('show.bs.modal', function (event) {
            var btnblock = $(event.relatedTarget);
            id = btnblock.data('userid');
        });

        $("a[name='block-user']").click(function(){
            permission = -1;
            $.ajax({
                url: '/users',
                method: 'PUT',
                data: {
                    id,
                    permission
                },
                success: function(data) {
                    $('#block-btn-' + id).hide();
                    $('#unblock-btn-' + id).show();
                },
                error: function(err) {

                }
            });
        });

        $('#WarningModalalert').on('show.bs.modal', function (event) {
            var btnunblock = $(event.relatedTarget);
            id = btnunblock.data('userid');
            console.log(id);
        });

        $("a[name='unblock-user']").click(function(){
            permission = 0;
            console.log(id);
            $.ajax({
                url: '/users',
                method: 'PUT',
                data: {
                    id,
                    permission
                },
                success: function(data) {
                    $('#block-btn-' + id).show();
                    $('#unblock-btn-' + id).hide();
                },
                error: function(err) {

                }
            });
        });
    });

    function generatePager(paginationArray, prevPage, nextPage){
		let result = [];
		result.push(`
			<li class="my-page-item">
				<input onchange='startSubmit(this);' style="display: none;" id="page-prev" value="${prevPage}" type="radio" name="page"/>
				<label for="page-prev"  class="my-page-button">Prev</label>
			</li>
		`)
		paginationArray.forEach(page=>{
			if(page.isCurrent){
				result.push(`
					<li class="my-page-item">
						<input onchange='startSubmit(this);' style="display: none;" id="page-${page.page}" value="${page.page}" type="radio" name="page"/>
						<label for="page-${page.page}"  class="my-page-link my-current-page">${page.page}</label>
					</li>
				`)
			}else{
				result.push(`
					<li class="my-page-item">
						<input onchange='startSubmit(this);' style="display: none;" id="page-${page.page}" value="${page.page}" type="radio" name="page"/>
						<label for="page-${page.page}"  class="my-page-link">${page.page}</label>
					</li>
				`)
			}
		});
		result.push(`
			<li class="my-page-item">
				<input onchange='startSubmit(this);' style="display: none;" id="page-next" value="${nextPage}" type="radio" name="page"/>
				<label for="page-next"  class="my-page-button">Next</label>
			</li>
		`)
		return result;
	}
	function generateuser(users){
		return users.map(user=>{
			let gender = ``;
            if(user.f_sex){
                if(user.f_sex === 1){
                    gender =`Women`;
                }else if(user.f_sex === 2){
                    gender =`Other`;
                }
            }else{
                if(user.f_sex === 0){
                    gender =`Men`;
                }else{
                    gender = `Empty`
                }
            }
            let address = `Empty`;
            if(user.f_address){
                address = `${user.f_address}`;
            }
            let phone = `Empty`;
            if(user.f_phone){
                 phone = `${user.f_phone}`;
            }
            let action = ``;
            if(user.f_permission === 0){
                action = `
                    <a id="block-btn-${user.f_ID}" type="button" class="Danger danger-color" href="" data-toggle="modal" data-target="#DangerModalalert" data-userid="${user.f_ID}" name="ask-block-user">Block</a>
                    <a style="display: none;" id="unblock-btn-${user.f_ID}" type="button" class="Warning warning-color" href="" data-toggle="modal" data-target="#WarningModalalert" data-userid="${user.f_ID}" name="ask-unblock-user">Unblock</a>
                `
            }else{
                action = `
                    <a style="display: none;" id="block-btn-${user.f_ID}" type="button" class="Danger danger-color" href="" data-toggle="modal" data-target="#DangerModalalert" data-userid="${user.f_ID}" name="ask-block-user">Block</a>
                    <a id="unblock-btn-${user.f_ID}" type="button" class="Warning warning-color" href="" data-toggle="modal" data-target="#WarningModalalert" data-userid="${user.f_ID}" name="ask-unblock-user">Unblock</a>
                `
            }
			return `
                <tr>
                    <td>${user.No}</td>
                    <td>${user.f_firstname} ${user.f_lastname} </td>
                    <td>
                       `+gender+`
                    </td>
                    <td>
                        `+address+`
                    </td>
                    <td>
                        `+phone+`
                    </td>
                    <td>
                         <div class="modal-area-button">
                            <a class="Primary mg-b-10" href="/users/{{this.f_ID}}">Details</a>
                            `+action+`
                        </div>
                    </td>
                </tr>
			`;
		})
	}
	
	function startSubmit(ele){
		const data = {};
		data.page = $("input[name='page']:checked").val();
		
		let queryString = "";
		if(!data.page){
			data.page = '1';
		}
		if(ele.getAttribute("name") !== "page"){
			data.page = '1';
		}
		if(data.page.length > 0){
			queryString += ("page=" + data.page);
		}
		const newRelativePathQuery = window.location.pathname + '?' + queryString;
		history.pushState(null, '', newRelativePathQuery);
			$.ajax({
			method:'get',
			url: '/users/filter',
			data: data,
			success: function(data){
				$("#my-pagination").empty();
				if(data.paginationArray && data.paginationArray.length > 0){
					const pageView = generatePager(data.paginationArray, data.prevPage, data.nextPage);
					pageView.forEach(page=>{
						$("#my-pagination").append(page);
					});
				}
				const userView = generateuser(data.users);
				$("#table-body").empty();
				userView.forEach(user=>{
					$("#table-body").append(user);
				});
			},
			error: function(err){
				console.log(err);
				alert("An error has occurred, please try again");
			}
		})
	}
</script>
{{/section}}